{% extends 'Gestion_de_Alumnos/base.html' %}
{% load static %}

{% block content %}
<style>
.dashboard-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border-radius: 10px;
}

.dashboard-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.module-icon {
    color: #28a745;
}

.dashboard-header {
    border-bottom: 1px solid rgba(255,255,255,0.1);
    padding-bottom: 1rem;
}

.section-title {
    color: #ffffff;
    font-weight: 600;
}

.btn-primary {
    background-color: #28a745 !important;
    border-color: #28a745 !important;
    border-radius: 20px;
    padding: 0.375rem 1.5rem;
}

.btn-primary:hover {
    background-color: #218838 !important;
    border-color: #218838 !important;
}

.btn-success {
    background-color: #20c997 !important;
    border-color: #20c997 !important;
}

.btn-warning {
    background-color: #ffc107 !important;
    border-color: #ffc107 !important;
    color: #212529;
}

/* Estilos para el formulario de actividades */
.activity-form {
    background-color: #1a1d29;
    border-radius: 10px;
    padding: 2rem;
}

.activity-section {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background-color: #2a2e3f;
    border-radius: 8px;
    border-left: 4px solid #28a745;
}

.activity-section-title {
    color: #ffffff;
    font-weight: 600;
    margin-bottom: 1.5rem;
    font-size: 1.2rem;
}

.category-badge {
    font-size: 0.8rem;
    padding: 0.3rem 0.8rem;
    border-radius: 15px;
}

.form-control, .form-select {
    background-color: #2a2e3f;
    border: 1px solid rgba(255,255,255,0.1);
    color: white;
}

.form-control:focus, .form-select:focus {
    background-color: #2a2e3f;
    border-color: #28a745;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

.form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
}

.alert {
    border-radius: 10px;
}

.participants-list {
    max-height: 200px;
    overflow-y: auto;
}

.participant-item {
    background-color: #2a2e3f;
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 5px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
}

.required-field::after {
    content: " *";
    color: #dc3545;
}

.activity-preview {
    background: linear-gradient(135deg, #2a2e3f 0%, #1a1d29 100%);
    border-radius: 10px;
    padding: 1.5rem;
    border: 2px dashed #28a745;
}

.preview-item {
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.preview-label {
    font-weight: 600;
    color: #28a745;
    margin-bottom: 0.25rem;
}

.preview-value {
    color: #ffffff;
}
</style>

<main class="dashboard-container">
    <header class="dashboard-header mb-4">
        <h1 class="display-5 fw-bold">Registro de Actividades Extraescolares</h1>
        <p class="lead">Sistema de gestión de actividades complementarias del Tecnológico de Chihuahua 2</p>
    </header>
    
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="activity-form">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle me-2"></i>
                    Complete el siguiente formulario para registrar una nueva actividad extraescolar. 
                    Todos los campos marcados con <span class="text-danger">*</span> son obligatorios.
                </div>
                
                <form id="formActividadExtra">
                    {% csrf_token %}
                    
                    <!-- Información básica de la actividad -->
                    <div class="activity-section">
                        <h3 class="activity-section-title">
                            <i class="bi bi-calendar-event me-2"></i>Información General de la Actividad
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required-field">Nombre de la Actividad</label>
                                <input type="text" class="form-control" name="nombre_actividad" required
                                       placeholder="Ej: Torneo Interescolar de Ajedrez">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label required-field">Tipo de Actividad</label>
                                <select class="form-select" name="tipo_actividad" required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="deportiva">Deportiva</option>
                                    <option value="cultural">Cultural</option>
                                    <option value="academica">Académica</option>
                                    <option value="artistica">Artística</option>
                                    <option value="voluntariado">Voluntariado</option>
                                    <option value="tecnologica">Tecnológica</option>
                                    <option value="otro">Otro</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label class="form-label">Descripción de la Actividad</label>
                                <textarea class="form-control" name="descripcion" rows="3" 
                                          placeholder="Describa los objetivos, actividades a realizar y beneficios para los participantes..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label required-field">Fecha de Inicio</label>
                                <input type="date" class="form-control" name="fecha_inicio" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Fecha de Término</label>
                                <input type="date" class="form-control" name="fecha_termino">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label required-field">Horario</label>
                                <input type="text" class="form-control" name="horario" required
                                       placeholder="Ej: Lunes y Miércoles 16:00-18:00">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ubicación y recursos -->
                    <div class="activity-section">
                        <h3 class="activity-section-title">
                            <i class="bi bi-geo-alt me-2"></i>Ubicación y Recursos
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required-field">Lugar de Realización</label>
                                <input type="text" class="form-control" name="lugar" required
                                       placeholder="Ej: Gimnasio principal, Aula A-101">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Responsable de la Actividad</label>
                                <select class="form-select" name="responsable" required>
                                    <option value="">Seleccionar responsable...</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Recursos Necesarios</label>
                                <textarea class="form-control" name="recursos" rows="2" 
                                          placeholder="Ej: Equipo de sonido, material deportivo..."></textarea>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Presupuesto Estimado</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" class="form-control" name="presupuesto" 
                                           placeholder="0.00" min="0" step="0.01">
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Cupo Máximo</label>
                                <input type="number" class="form-control" name="cupo_maximo" 
                                       placeholder="Número máximo de participantes" min="1">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Participantes -->
                    <div class="activity-section">
                        <h3 class="activity-section-title">
                            <i class="bi bi-people me-2"></i>Participantes
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Agregar Participantes</label>
                                <select class="form-select" id="selectParticipante" multiple>
                                    <option value="">Cargando alumnos...</option>
                                </select>
                                <div class="form-text">Mantenga presionada la tecla Ctrl para seleccionar múltiples alumnos</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Participantes Seleccionados</label>
                                <div class="participants-list" id="listaParticipantes">
                                    <div class="alert alert-secondary text-center">
                                        <i class="bi bi-info-circle me-1"></i>
                                        No hay participantes seleccionados
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-12">
                                <button type="button" class="btn btn-outline-success btn-sm" onclick="agregarParticipantes()">
                                    <i class="bi bi-plus-circle me-1"></i>Agregar Participantes Seleccionados
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="limpiarParticipantes()">
                                    <i class="bi bi-trash me-1"></i>Limpiar Lista
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Requisitos y criterios -->
                    <div class="activity-section">
                        <h3 class="activity-section-title">
                            <i class="bi bi-clipboard-check me-2"></i>Requisitos y Criterios
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Requisitos de Participación</label>
                                <textarea class="form-control" name="requisitos" rows="3" 
                                          placeholder="Ej: Promedio mínimo 8.0, uniforme deportivo..."></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Criterios de Evaluación</label>
                                <textarea class="form-control" name="criterios_evaluacion" rows="3" 
                                          placeholder="Ej: Asistencia 80%, participación activa..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Horas Crédito</label>
                                <input type="number" class="form-control" name="horas_credito" 
                                       placeholder="Horas acreditables" min="0">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Reconocimiento</label>
                                <select class="form-select" name="tipo_reconocimiento">
                                    <option value="">Sin reconocimiento</option>
                                    <option value="constancia">Constancia</option>
                                    <option value="diploma">Diploma</option>
                                    <option value="medalla">Medalla</option>
                                    <option value="creditos">Créditos complementarios</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Actividad Certificada</label>
                                <div class="form-check mt-2">
                                    <input class="form-check-input" type="checkbox" name="certificada" value="true">
                                    <label class="form-check-label">Esta actividad otorga certificación</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="activity-section">
                        <h3 class="activity-section-title">
                            <i class="bi bi-chat-left-text me-2"></i>Información Adicional
                        </h3>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Observaciones</label>
                                <textarea class="form-control" name="observaciones" rows="3" 
                                          placeholder="Observaciones adicionales sobre la actividad..."></textarea>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Recomendaciones</label>
                                <textarea class="form-control" name="recomendaciones" rows="3" 
                                          placeholder="Recomendaciones para los participantes..."></textarea>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Material de Apoyo</label>
                                <input type="file" class="form-control" name="material_apoyo" 
                                       accept=".pdf,.doc,.docx,.ppt,.pptx">
                                <div class="form-text">Formatos permitidos: PDF, Word, PowerPoint</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Enlace de Referencia</label>
                                <input type="url" class="form-control" name="enlace_referencia" 
                                       placeholder="https://...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vista previa y envío -->
                    <div class="activity-section">
                        <h3 class="activity-section-title">
                            <i class="bi bi-eye me-2"></i>Vista Previa y Envío
                        </h3>
                        
                        <div class="activity-preview mb-4">
                            <h5 class="text-center mb-3" style="color: #28a745;">Vista Previa de la Actividad</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="preview-item">
                                        <div class="preview-label">Nombre:</div>
                                        <div class="preview-value" id="previewNombre">-</div>
                                    </div>
                                    <div class="preview-item">
                                        <div class="preview-label">Tipo:</div>
                                        <div class="preview-value" id="previewTipo">-</div>
                                    </div>
                                    <div class="preview-item">
                                        <div class="preview-label">Fechas:</div>
                                        <div class="preview-value" id="previewFechas">-</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="preview-item">
                                        <div class="preview-label">Lugar:</div>
                                        <div class="preview-value" id="previewLugar">-</div>
                                    </div>
                                    <div class="preview-item">
                                        <div class="preview-label">Horario:</div>
                                        <div class="preview-value" id="previewHorario">-</div>
                                    </div>
                                    <div class="preview-item">
                                        <div class="preview-label">Participantes:</div>
                                        <div class="preview-value" id="previewParticipantes">0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Importante:</strong> Revise la información antes de enviar. 
                            Una vez registrada la actividad, deberá ser aprobada por el departamento correspondiente.
                        </div>
                        
                        <div class="form-check mb-4">
                            <input class="form-check-input" type="checkbox" id="confirmacionRegistro" required>
                            <label class="form-check-label" for="confirmacionRegistro">
                                Confirmo que la información proporcionada es correcta y me hago responsable de la actividad registrada
                            </label>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary me-md-2" onclick="limpiarFormulario()">
                                <i class="bi bi-arrow-clockwise me-1"></i>Limpiar Formulario
                            </button>
                            <button type="button" class="btn btn-warning me-md-2" onclick="actualizarVistaPrevia()">
                                <i class="bi bi-arrow-repeat me-1"></i>Actualizar Vista Previa
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send me-1"></i>Registrar Actividad
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</main>

<script>
// JavaScript para el formulario de actividades extraescolares
const API_BASE = '/api';
let participantesSeleccionados = [];

// Función para cargar responsables (profesores)
async function cargarResponsables() {
    try {
        const response = await fetch(`${API_BASE}/profesores/`);
        if (!response.ok) throw new Error('Error al cargar responsables');
        
        const profesores = await response.json();
        const select = document.querySelector('select[name="responsable"]');
        
        select.innerHTML = '<option value="">Seleccionar responsable...</option>';
        profesores.forEach(profesor => {
            const option = document.createElement('option');
            option.value = profesor.id_profesor;
            option.textContent = `${profesor.nombre} - ${profesor.departamento}`;
            select.appendChild(option);
        });
        
        return profesores;
    } catch (error) {
        console.error('Error cargando responsables:', error);
        mostrarError('Error al cargar los responsables');
        return [];
    }
}

// Función para cargar alumnos para participantes
async function cargarAlumnosParticipantes() {
    try {
        const response = await fetch(`${API_BASE}/alumnos/`);
        if (!response.ok) throw new Error('Error al cargar alumnos');
        
        const alumnos = await response.json();
        const select = document.getElementById('selectParticipante');
        
        select.innerHTML = '';
        alumnos.forEach(alumno => {
            const option = document.createElement('option');
            option.value = alumno.id_alumno;
            option.textContent = `${alumno.nombre} - ${alumno.numero_control || 'N/A'}`;
            select.appendChild(option);
        });
        
        return alumnos;
    } catch (error) {
        console.error('Error cargando alumnos:', error);
        mostrarError('Error al cargar los alumnos');
        return [];
    }
}

// Función para agregar participantes a la lista
function agregarParticipantes() {
    const select = document.getElementById('selectParticipante');
    const selectedOptions = Array.from(select.selectedOptions);
    
    if (selectedOptions.length === 0) {
        mostrarError('Seleccione al menos un participante');
        return;
    }
    
    selectedOptions.forEach(option => {
        const alumnoId = option.value;
        const alumnoNombre = option.textContent;
        
        // Evitar duplicados
        if (!participantesSeleccionados.find(p => p.id === alumnoId)) {
            participantesSeleccionados.push({
                id: alumnoId,
                nombre: alumnoNombre
            });
        }
    });
    
    actualizarListaParticipantes();
    select.selectedIndex = -1; // Limpiar selección
}

// Función para actualizar la lista visual de participantes
function actualizarListaParticipantes() {
    const lista = document.getElementById('listaParticipantes');
    
    if (participantesSeleccionados.length === 0) {
        lista.innerHTML = `
            <div class="alert alert-secondary text-center">
                <i class="bi bi-info-circle me-1"></i>
                No hay participantes seleccionados
            </div>
        `;
        return;
    }
    
    lista.innerHTML = '';
    participantesSeleccionados.forEach((participante, index) => {
        const item = document.createElement('div');
        item.className = 'participant-item';
        item.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <span>${participante.nombre}</span>
                <button type="button" class="btn btn-sm btn-outline-danger" 
                        onclick="eliminarParticipante(${index})">
                    <i class="bi bi-x"></i>
                </button>
            </div>
        `;
        lista.appendChild(item);
    });
}

// Función para eliminar un participante
function eliminarParticipante(index) {
    participantesSeleccionados.splice(index, 1);
    actualizarListaParticipantes();
}

// Función para limpiar todos los participantes
function limpiarParticipantes() {
    if (participantesSeleccionados.length > 0) {
        if (confirm('¿Está seguro de que desea eliminar todos los participantes?')) {
            participantesSeleccionados = [];
            actualizarListaParticipantes();
            mostrarExito('Lista de participantes limpiada');
        }
    }
}

// Función para actualizar la vista previa
function actualizarVistaPrevia() {
    const form = document.getElementById('formActividadExtra');
    const formData = new FormData(form);
    
    document.getElementById('previewNombre').textContent = 
        formData.get('nombre_actividad') || '-';
    
    document.getElementById('previewTipo').textContent = 
        formData.get('tipo_actividad') || '-';
    
    const fechaInicio = formData.get('fecha_inicio');
    const fechaTermino = formData.get('fecha_termino');
    document.getElementById('previewFechas').textContent = 
        fechaInicio ? (fechaTermino ? `${fechaInicio} al ${fechaTermino}` : fechaInicio) : '-';
    
    document.getElementById('previewLugar').textContent = 
        formData.get('lugar') || '-';
    
    document.getElementById('previewHorario').textContent = 
        formData.get('horario') || '-';
    
    document.getElementById('previewParticipantes').textContent = 
        participantesSeleccionados.length;
    
    mostrarExito('Vista previa actualizada');
}

// Envío del formulario
document.getElementById('formActividadExtra').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    // Agregar participantes al objeto de datos
    data.participantes = participantesSeleccionados;
    
    // Validar campos requeridos
    const requiredFields = this.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        if (!field.value) {
            isValid = false;
            field.classList.add('is-invalid');
        } else {
            field.classList.remove('is-invalid');
        }
    });
    
    if (!isValid) {
        mostrarError('Por favor complete todos los campos requeridos');
        return;
    }
    
    // Validar que haya al menos un participante si es necesario
    if (participantesSeleccionados.length === 0) {
        if (!confirm('No ha seleccionado ningún participante. ¿Desea continuar?')) {
            return;
        }
    }
    
    try {
        // En una implementación real, aquí se enviaría el FormData completo para manejar archivos
        const response = await fetch(`${API_BASE}/actividades-extraescolares/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': data.csrfmiddlewaretoken
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        if (result.success) {
            mostrarExito('Actividad extraescolar registrada exitosamente. Será revisada por el departamento correspondiente.');
            limpiarFormulario();
        } else {
            mostrarError(result.message);
        }
    } catch (error) {
        mostrarError('Error de conexión: ' + error);
    }
});

// Limpiar formulario completo
function limpiarFormulario() {
    if (confirm('¿Está seguro de que desea limpiar todo el formulario? Se perderán todos los datos ingresados.')) {
        document.getElementById('formActividadExtra').reset();
        participantesSeleccionados = [];
        actualizarListaParticipantes();
        actualizarVistaPrevia();
        mostrarExito('Formulario limpiado correctamente');
    }
}

// Funciones de utilidad
function mostrarExito(mensaje) {
    // Puedes usar Toast de Bootstrap o alert simple
    alert('Éxito: ' + mensaje);
}

function mostrarError(mensaje) {
    alert('Error: ' + mensaje);
}

// Inicialización cuando el documento está listo
document.addEventListener('DOMContentLoaded', function() {
    cargarResponsables();
    cargarAlumnosParticipantes();
    
    // Actualizar vista previa automáticamente cuando cambien los campos principales
    const camposPrincipales = ['nombre_actividad', 'tipo_actividad', 'fecha_inicio', 'fecha_termino', 'lugar', 'horario'];
    camposPrincipales.forEach(campo => {
        document.querySelector(`[name="${campo}"]`)?.addEventListener('change', actualizarVistaPrevia);
    });
});
</script>

{% endblock %}